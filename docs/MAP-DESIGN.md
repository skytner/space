# –ö–∞—Ä—Ç–∞ ‚Äî –¥–∏–∑–∞–π–Ω –∏ —Å—Ö–µ–º–∞

–í–∏–∑—É–∞–ª—å–Ω–∞—è –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–∞—è —Å—Ö–µ–º–∞ –∫–∞—Ä—Ç—ã: —Å–ª–æ–∏, –¥–∞–Ω–Ω—ã–µ, –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, —Å—Ü–µ–Ω–∞—Ä–∏–∏.

---

## 1. –≠–∫—Ä–∞–Ω –∫–∞—Ä—Ç—ã (–º–∞–∫–µ—Ç)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  [2D] [3D]    Layers: [‚úì Stars] [‚úì Grid] [‚úì Markers]         [üîç] [‚öô]     ‚îÇ  ‚Üê –¢—É–ª–±–∞—Ä
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                             ‚îÇ
‚îÇ    ¬∑              ¬∑         ‚òÖ                                              ‚îÇ
‚îÇ  ¬∑   ¬∑   ‚òÖ       ¬∑    ¬∑         ¬∑                                          ‚îÇ
‚îÇ        ¬∑     ¬∑   ¬∑         ¬∑        ¬∑      ‚Üê –°–ª–æ–π 1: –∑–≤—ë–∑–¥—ã + —Å–µ—Ç–∫–∞ (canvas)‚îÇ
‚îÇ  ¬∑       [üõ∏]      ¬∑    ¬∑   ¬∑                                               ‚îÇ
‚îÇ    ¬∑   ¬∑     ¬∑         [ü™ê]    ¬∑     ¬∑    ‚Üê –°–ª–æ–π 2: –º–∞—Ä–∫–µ—Ä—ã (DOM –∏–ª–∏ canvas)‚îÇ
‚îÇ  ¬∑     ¬∑    ¬∑   ¬∑   ¬∑      [üî≠]   ¬∑                                         ‚îÇ
‚îÇ    ¬∑        ¬∑    ¬∑   ¬∑         ¬∑                                            ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îÇ  ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ pan (drag) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂                        ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îÇ  –ö–ª–∏–∫ –ø–æ –º–∞—Ä–∫–µ—Ä—É ‚Üí –∫–∞—Ä—Ç–æ—á–∫–∞ / –±–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 2. –°–ª–æ–∏ (z-index –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å)

```mermaid
flowchart TB
    subgraph Z1["z: 0 ‚Äî –°–ª–æ–π 1: –§–æ–Ω"]
        A[Canvas: –∑–≤—ë–∑–¥—ã]
        B[–°–µ—Ç–∫–∞]
        C[–ì—Ä–∞–¥–∏–µ–Ω—Ç]
    end
    subgraph Z2["z: 1 ‚Äî –°–ª–æ–π 2: –ö–æ–Ω—Ç–µ–Ω—Ç –∫–∞—Ä—Ç—ã"]
        D[–ú–∞—Ä–∫–µ—Ä—ã]
        E[–ò–∫–æ–Ω–∫–∏ + –ø–æ–¥–ø–∏—Å–∏]
    end
    subgraph Z3["z: 10 ‚Äî –°–ª–æ–π 3: UI"]
        F[–¢—É–ª–±–∞—Ä]
        G[–ö–∞—Ä—Ç–æ—á–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ]
        H[–ü–∞–Ω–µ–ª–∏]
    end

    Z1 --> Z2
    Z2 --> Z3
```

| –°–ª–æ–π | –°–æ–¥–µ—Ä–∂–∏–º–æ–µ | –†–µ–Ω–¥–µ—Ä |
|------|------------|--------|
| **1** | –ó–≤—ë–∑–¥—ã, —Å–µ—Ç–∫–∞, –≥—Ä–∞–¥–∏–µ–Ω—Ç | Canvas |
| **2** | –ú–∞—Ä–∫–µ—Ä—ã (—Ç–æ—á–∫–∏, –∏–∫–æ–Ω–∫–∏, label) | DOM –∏–ª–∏ –≤—Ç–æ—Ä–æ–π Canvas |
| **3** | –¢—É–ª–±–∞—Ä, tooltip, –ø–∞–Ω–µ–ª–∏ | DOM |

---

## 3. –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö (—Å—É—â–Ω–æ—Å—Ç–∏)

```mermaid
erDiagram
    MapViewState ||--o| Pan : has
    MapViewState ||--o| Zoom : has
    MapViewState ||--o| MapLayers : has
    MapLayers ||--o| starsVisible : boolean
    MapLayers ||--o| gridVisible : boolean
    MapLayers ||--o| markersVisible : boolean

    MapMarker ||--o| id : string
    MapMarker ||--o| worldX : number
    MapMarker ||--o| worldY : number
    MapMarker ||--o| label : string
    MapMarker ||--o| type : MarkerType
    MapMarker ||--o| description : string

    MapViewState ||--o{ MapMarker : displays
    SelectedMarker ||--o| MapMarker : references

    MapViewState {
        number panX
        number panY
        number zoom
    }

    MapMarker {
        string id
        number worldX
        number worldY
        string label
        MarkerType type
        string description
    }

    MarkerType {
        "ship"
        "station"
        "planet"
        "custom"
    }
```

---

## 4. –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: –º–∏—Ä ‚Üî —ç–∫—Ä–∞–Ω

```mermaid
flowchart LR
    subgraph World["–ú–∏—Ä–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã"]
        W["(worldX, worldY)"]
    end
    subgraph View["–°–æ—Å—Ç–æ—è–Ω–∏–µ –≤–∏–¥–∞"]
        P["panX, panY"]
        Z["zoom"]
    end
    subgraph Screen["–≠–∫—Ä–∞–Ω (px)"]
        S["(screenX, screenY)"]
    end

    W --> T["worldToScreen()"]
    P --> T
    Z --> T
    T --> S

    S --> U["screenToWorld()"]
    P --> U
    Z --> U
    U --> W
```

**–§–æ—Ä–º—É–ª–∞ (2D, zoom = 1):**

- `screenX = worldX - panX`
- `screenY = worldY - panY`
- `worldX = screenX + panX`
- `worldY = screenY + panY`

–ü—Ä–∏ zoom: –¥–æ–º–Ω–æ–∂–∞—Ç—å –Ω–∞ `scale` –∏ —É—á–∏—Ç—ã–≤–∞—Ç—å —Ü–µ–Ω—Ç—Ä –≤–∏–¥–∞.

---

## 5. –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

```mermaid
flowchart TB
    subgraph User["–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"]
        U1[Drag –∫–∞—Ä—Ç—ã]
        U2[–ö–ª–∏–∫ –ø–æ –º–∞—Ä–∫–µ—Ä—É]
        U3[–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–ª–æ—ë–≤]
    end

    subgraph State["–°–æ—Å—Ç–æ—è–Ω–∏–µ"]
        S1["panX, panY"]
        S2["selectedMarkerId"]
        S3["layers: stars, grid, markers"]
    end

    subgraph Render["–†–µ–Ω–¥–µ—Ä"]
        R1[CanvasMap]
        R2[MarkersLayer]
        R3[Toolbar]
        R4[MarkerCard]
    end

    U1 --> S1
    U2 --> S2
    U3 --> S3

    S1 --> R1
    S1 --> R2
    S2 --> R4
    S3 --> R1
    S3 --> R2
    S3 --> R3
```

---

## 6. –°—Ü–µ–Ω–∞—Ä–∏–π: –≤—ã–±–æ—Ä –º–∞—Ä–∫–µ—Ä–∞

```mermaid
sequenceDiagram
    participant User
    participant MarkersLayer
    participant State
    participant MarkerCard

    User->>MarkersLayer: –∫–ª–∏–∫ –ø–æ –º–∞—Ä–∫–µ—Ä—É
    MarkersLayer->>State: setSelectedMarkerId(id)
    State->>MarkersLayer: re-render (highlight)
    State->>MarkerCard: show(marker)
    MarkerCard->>User: –∫–∞—Ä—Ç–æ—á–∫–∞ —Å –¥–µ—Ç–∞–ª—è–º–∏
    User->>MarkerCard: –∑–∞–∫—Ä—ã—Ç—å / –∫–ª–∏–∫ –º–∏–º–æ
    MarkerCard->>State: setSelectedMarkerId(null)
```

---

## 7. –ü–æ—Ä—è–¥–æ–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

```mermaid
flowchart LR
    A["1. –¢–∏–ø—ã:\nMapMarker, MapViewState,\nMapLayers"] --> B["2. worldToScreen\n/ screenToWorld"]
    B --> C["3. –°–ª–æ–π –º–∞—Ä–∫–µ—Ä–æ–≤\n(DOM –ø–æ–≤–µ—Ä—Ö canvas)"]
    C --> D["4. –ö–ª–∏–∫ + selectedMarkerId\n+ –∫–∞—Ä—Ç–æ—á–∫–∞"]
    D --> E["5. –¢—É–ª–±–∞—Ä —Å–ª–æ—ë–≤\n(–≤–∫–ª/–≤—ã–∫–ª –∑–≤—ë–∑–¥—ã, —Å–µ—Ç–∫–∞, –º–∞—Ä–∫–µ—Ä—ã)"]
```

| –®–∞–≥ | –ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å |
|-----|-------------|
| 1 | –¢–∏–ø—ã: `MapMarker`, `MarkerType`, `MapViewState`, `MapLayers`. –ú–æ–∫-–º–∞—Å—Å–∏–≤ –º–∞—Ä–∫–µ—Ä–æ–≤. |
| 2 | –§—É–Ω–∫—Ü–∏–∏ –ø–µ—Ä–µ—Å—á—ë—Ç–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —Å —É—á—ë—Ç–æ–º pan (–∏ zoom –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏). |
| 3 | –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–≤–µ—Ä—Ö canvas, –º–∞—Ä–∫–µ—Ä—ã –∫–∞–∫ DOM-—ç–ª–µ–º–µ–Ω—Ç—ã —Å –ø–æ–∑–∏—Ü–∏–µ–π –∏–∑ `worldToScreen`. |
| 4 | State –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞, –∫–ª–∏–∫ –ø–æ –º–∞—Ä–∫–µ—Ä—É, –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏/–ø–∞–Ω–µ–ª–∏. |
| 5 | –ß–µ–∫–±–æ–∫—Å—ã/–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ —Å–ª–æ—ë–≤ –≤ —Ç—É–ª–±–∞—Ä–µ, –ø—Ä–æ–±—Ä–æ—Å –≤ CanvasMap –∏ —Å–ª–æ–π –º–∞—Ä–∫–µ—Ä–æ–≤. |

---

## 8. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (–¥–µ—Ä–µ–≤–æ)

```
MapView
‚îú‚îÄ‚îÄ MapModeProvider
‚îÇ   ‚îú‚îÄ‚îÄ ToggleMapMode (2D/3D)
‚îÇ   ‚îî‚îÄ‚îÄ MapModeResolver
‚îÇ       ‚îî‚îÄ‚îÄ CanvasMap (–∑–≤—ë–∑–¥—ã, —Å–µ—Ç–∫–∞)
‚îú‚îÄ‚îÄ MarkersLayer          ‚Üê –ø–æ–≤–µ—Ä—Ö canvas, overflow: hidden
‚îÇ   ‚îî‚îÄ‚îÄ MapMarkerItem[]   (position from worldToScreen)
‚îú‚îÄ‚îÄ MapToolbar            ‚Üê —Å–ª–æ–∏, –ø–æ–∏—Å–∫, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
‚îî‚îÄ‚îÄ MarkerCard | SidePanel   ‚Üê –ø—Ä–∏ selectedMarkerId
```

---

–ì–æ—Ç–æ–≤–æ: –æ–¥–Ω–∞ —Å—Ö–µ–º–∞ –≤ –æ–¥–Ω–æ–º MD ‚Äî –º–∞–∫–µ—Ç —ç–∫—Ä–∞–Ω–∞, —Å–ª–æ–∏, –º–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö, –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, –ø–æ—Ç–æ–∫ –∏ –ø–æ—Ä—è–¥–æ–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.
